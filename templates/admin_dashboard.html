{% extends "base.html" %}

{% block title %}Admin Dashboard - Quản lý PDF{% endblock %}

{% block content %}
<style>
    /* Giảm chiều cao button "Xem" trong bảng lịch sử */
    #historyTable .view-history {
        padding: 0.25rem 0.75rem;
        line-height: 1.2;
        font-size: 0.875rem;
    }
</style>
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-cogs"></i> Quản lý hệ thống</h2>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-eye"></i> Xem trang chủ
                </a>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </a>
            </div>
        </div>

        {% if error %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> {{ error }}
        </div>
        {% endif %}

        <!-- Upload PDF -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-upload"></i> Upload file PDF mới</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="file" class="form-control" id="pdfFile" accept=".pdf" multiple>
                            <div class="form-text">
                                Có thể chọn nhiều file PDF cùng lúc<br>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                        </div>
                    </div>
                    
                    <!-- Caption cho file -->
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">
                                <i class="fas fa-comment"></i> Mô tả file (tùy chọn)
                            </label>
                            <div id="captionContainer">
                                <!-- Caption sẽ được thêm động ở đây -->
                            </div>
                        </div>
                    </div>
                </form>
                <div id="uploadResult" class="mt-3"></div>
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="progressText">Đang xử lý...</small>
                </div>
            </div>
        </div>


        <!-- Thống kê -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h4 id="totalFiles">{{ pdfs|length }}</h4>
                        <p class="mb-0">Tổng số file</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h4 id="totalChunks">{{ pdfs|sum(attribute='total_chunks') }}</h4>
                        <p class="mb-0">Tổng số đoạn văn bản</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h4 id="totalSize">{{ "%.1f"|format((pdfs|sum(attribute='file_size')) / 1024 / 1024) }}</h4>
                        <p class="mb-0">Tổng dung lượng (MB)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Biểu đồ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-line"></i> Upload theo ngày (7 ngày gần nhất)</div>
                    <div class="card-body">
                        <canvas id="uploadChart" height="120"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-pie"></i> File được quan tâm nhiều nhất</div>
                    <div class="card-body">
                        <canvas id="filePie" height="120"></canvas>
                    </div>
                </div>
            </div>
        </div>

               <!-- Lịch sử tra cứu gần đây (hiển thị 8 bản ghi, có xem thêm) -->
               <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Lịch sử tra cứu gần đây</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="historyTable">
                            <thead>
                                <tr>
                                    <th>Thời gian</th>
                                    <th>Câu hỏi</th>
                                    <th>File thực dùng</th>
                                    <th style="width:72px"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="text-center mt-2">
                        <button id="historyShowMore" class="btn btn-outline-primary btn-sm" style="display:none;">Xem thêm</button>
                    </div>
                </div>
            </div>

        <!-- Danh sách PDF files -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Danh sách file PDF</h5>
            </div>
            <div class="card-body">
                {% if pdfs %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Tên file</th>
                                    <th>Kích thước</th>
                                    <th>Số đoạn</th>
                                    <th>Ngày tạo</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pdf in pdfs %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-pdf text-danger"></i>
                                        {{ pdf.filename }}<br>
                                        {% if pdf.caption %}
                                        <small style="color: #000055;">
                                            <i class="fas fa-comment"></i> {{ pdf.caption }}
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td>{{ "%.1f"|format(pdf.file_size / 1024 / 1024) }} MB</td>
                                    <td>
                                        <span class="badge bg-primary">{{ pdf.total_chunks }}</span>
                                    </td>
                                    <td>{{ pdf.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('view_pdf', filename=pdf.filename, from='admin') }}" 
                                               class="btn btn-outline-info" title="Xem chunks">
                                                <i class="fas fa-list"></i>
                                            </a>
                                            <button onclick="openPdfModal('{{ url_for('view_pdf_file', filename=pdf.filename) }}', '{{ pdf.filename }}')" 
                                                    class="btn btn-outline-primary" title="Xem PDF">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="{{ url_for('download_pdf', filename=pdf.filename) }}" 
                                               class="btn btn-outline-success" title="Tải xuống">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <button class="btn btn-outline-danger" 
                                                    onclick="deleteFile('{{ pdf.filename }}')" title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Chưa có file PDF nào được upload</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Tạo caption input khi chọn file
    $('#pdfFile').on('change', function() {
        const files = Array.from(this.files);
        const container = $('#captionContainer');
        container.empty();
        
        files.forEach((file, index) => {
            const captionHtml = `
                <div class="mb-2">
                    <label class="form-label small">
                        <i class="fas fa-file-pdf text-danger"></i> ${file.name}
                    </label>
                    <textarea class="form-control form-control-sm" 
                              id="caption_${index}" 
                              rows="1" 
                              placeholder="Mô tả cho ${file.name}..."></textarea>
                </div>
            `;
            container.append(captionHtml);
        });
    });

    // Upload form
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('pdfFile');
        
        if (fileInput.files.length === 0) {
            showResult('uploadResult', 'Vui lòng chọn file', 'danger');
            return;
        }
        
                // Upload tất cả file
                const files = Array.from(fileInput.files);
                let completed = 0, successCount = 0, errorMessages = [];
                
                // Hiển thị progress bar
                $('#uploadProgress').show();
                $('#uploadResult').hide();
                updateProgress(0, `Đang upload ${files.length} file(s)...`);
        
        // Upload tuần tự để tránh conflict
        uploadFileSequentially(files, 0);
        
        function uploadFileSequentially(files, index) {
            if (index >= files.length) {
                // Hoàn thành upload
                setTimeout(() => {
                    $('#uploadProgress').hide();
                    
                    let resultMessage = `Upload hoàn tất: ${successCount}/${files.length} file thành công`;
                    let resultType = 'success';
                    
                    if (errorMessages.length > 0) {
                        resultMessage += `<br><br><strong>Lỗi:</strong><br>${errorMessages.join('<br>')}`;
                        resultType = 'warning';
                    }
                    
                    showResult('uploadResult', resultMessage, resultType);
                    $('#pdfFile').val('');
                    $('#captionContainer').empty();
                    if (successCount > 0) setTimeout(() => location.reload(), 3000);
                }, 500);
                return;
            }
            
            const file = files[index];
            const formData = new FormData();
            formData.append('file', file);
            const caption = $(`#caption_${index}`).val().trim();
            formData.append('caption', caption);
            
            updateProgress((index / files.length) * 100, `Đang upload ${file.name} (${index + 1}/${files.length})...`);
            
            $.ajax({
                url: '/admin/upload',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: response => { 
                    if (response.success) {
                        successCount++;
                        console.log(`Upload thành công: ${file.name}`);
                    } else {
                        errorMessages.push(`${file.name}: ${response.message}`);
                        console.log(`Lỗi upload ${file.name}: ${response.message}`);
                    }
                },
                error: function(xhr, status, error) {
                    errorMessages.push(`${file.name}: Lỗi kết nối - ${error}`);
                    console.log(`Lỗi AJAX ${file.name}: ${error}`);
                },
                complete: function() {
                    completed++;
                    // Upload file tiếp theo
                    setTimeout(() => {
                        uploadFileSequentially(files, index + 1);
                    }, 1000); // Delay 1 giây giữa các file
                }
            });
        }
    });
});

// Vẽ biểu đồ từ dữ liệu API
$(function(){
    $.getJSON('/admin/chart-data', function(res){
        if(!res.success) return;
        const ucEl = document.getElementById('uploadChart');
        if (ucEl) {
            const uc = ucEl.getContext('2d');
            new Chart(uc, {
                type: 'line',
                data: {
                    labels: res.upload_data.labels,
                    datasets: [{ 
                        label: 'Số file', 
                        data: res.upload_data.data,
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78,115,223,0.15)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, precision: 0 } }
                }
            });
        }
        const fpEl = document.getElementById('filePie');
        if (fpEl) {
            const fp = fpEl.getContext('2d');
            new Chart(fp, {
                type: 'pie',
                data: { labels: res.file_data.labels, datasets: [{ data: res.file_data.data, backgroundColor: ['#4e73df','#1cc88a','#36b9cc','#f6c23e','#e74a3b'] }]},
                options: { responsive: true }
            });
        }
    });
});

// Lịch sử tra cứu: 8 bản ghi đầu, xem thêm/thu gọn, xem chi tiết
$(function(){
    const tbody = $('#historyTable tbody');
    let data = [];
    let shown = 8;

    function render() {
        tbody.empty();
        (data.slice(0, shown)).forEach(function(item, idx){
            const t = item.timestamp ? new Date(item.timestamp).toLocaleString() : '';
            const files = (item.actual_files_used && item.actual_files_used.length)
                ? item.actual_files_used.join(', ')
                : (item.filename || '');
            tbody.append(`
                <tr>
                    <td>${t}</td>
                    <td style="max-width:460px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${(item.question||'').replace(/\"/g,'&quot;')}">${item.question||''}</td>
                    <td style="max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${files}">${files}</td>
                    <td class="text-end"><button class="btn btn-sm btn-outline-secondary view-history" data-idx="${idx}">Xem</button></td>
                </tr>`);
        });
        if (data.length > shown) {
            $('#historyShowMore').show().text('Xem thêm');
        } else if (data.length > 8) {
            $('#historyShowMore').show().text('Thu gọn');
        } else {
            $('#historyShowMore').hide();
        }
    }

    $.getJSON('/admin/chat-history', function(res){
        if (!res.success) return;
        data = res.history || [];
        shown = Math.min(8, data.length);
        render();
    });

    $('#historyShowMore').on('click', function(){
        if (shown < data.length) shown = data.length; else shown = Math.min(8, data.length);
        render();
    });

    $(document).on('click', '.view-history', function(){
        const idx = parseInt($(this).data('idx'), 10);
        const item = data[idx];
        if (!item) return;
        const t = item.timestamp ? new Date(item.timestamp).toLocaleString() : '';
        const answer = (item.answer||'').replace(/\n/g, '\n');
        let src = '';
        const grouped = {};
        (item.sources||[]).forEach(function(s){
            if (!grouped[s.filename]) grouped[s.filename] = new Set();
            if (s.page_number!=null) grouped[s.filename].add(s.page_number);
        });
        Object.keys(grouped).forEach(function(f){
            const pages = Array.from(grouped[f]).sort((a,b)=>a-b);
            src += `\n- ${f}: ` + (pages.length?pages.map(p=>`Trang ${p}`).join(', '):'Trang không xác định');
        });
        alert(`Thời gian: ${t}\n\nCâu hỏi:\n${item.question||''}\n\nCâu trả lời:\n${answer}\n\nNguồn:${src||' (trống)'}`);
    });
});



function deleteFile(filename) {
    if (!confirm(`Bạn có chắc chắn muốn xóa file "${filename}"?`)) {
        return;
    }
    
    $.ajax({
        url: `/admin/delete/${filename}`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                alert('Đã xóa file thành công');
                location.reload();
            } else {
                alert('Lỗi: ' + response.message);
            }
        },
        error: function() {
            alert('Có lỗi xảy ra khi xóa file');
        }
    });
}


function showResult(elementId, message, type) {
    const alertClass = `alert-${type}`;
    $(`#${elementId}`).html(`<div class="alert ${alertClass}">${message}</div>`);
}

function updateProgress(percent, text) {
    $('.progress-bar').css('width', percent + '%');
    $('#progressText').text(text);
}

// Hàm mở modal PDF
function openPdfModal(pdfUrl, filename) {
    $('#pdfModalFilename').text(filename);
    $('#pdfModalDownload').attr('href', pdfUrl.replace('/view_pdf_file/', '/download/'));
    $('#pdfModalFrame').attr('src', pdfUrl);
    $('#pdfModal').modal('show');
}
</script>

<!-- Modal hiển thị PDF -->
<div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="pdfModalLabel">
                    <i class="fas fa-file-pdf"></i> <span id="pdfModalFilename"></span>
                </h5>
                <div>
                    <a id="pdfModalDownload" href="#" class="btn btn-light btn-sm me-2" download>
                        <i class="fas fa-download"></i> Tải xuống
                    </a>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-0" style="height: calc(100vh - 120px);">
                <iframe id="pdfModalFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
// Đóng modal khi click outside và giải phóng bộ nhớ
$('#pdfModal').on('hidden.bs.modal', function () {
    $('#pdfModalFrame').attr('src', ''); // Xóa src để giải phóng bộ nhớ
});
</script>
{% endblock %}
